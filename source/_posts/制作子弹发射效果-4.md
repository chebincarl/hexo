---
layout: title
title: 制作子弹发射效果-4
date: 2019-04-04 09:16:31
categories: Unity
tags: Unity5权威讲解
---
本章涵盖：
* 制作爆炸效果并设置爆炸威力
* 随机使用纹理

<!--more-->

# 制作爆炸效果并设置爆炸威力

导入Barel模型，将其置于场景中，然后发射子弹使其爆炸。
Project视图的Models/Barrel文件夹中有2个Barrel资源，可以通过图标区分3D模型原版和预设。

删除资源包自带的Barrel预设，使用原版3D模型。如下图所示，将原版Barrel模型拖曳到Scene视图，可以看到比玩家角色还大的油桶。将油桶调整到符合主人公角色大小比例的尺寸。

对于从外部导入的3D模型，绝对不要修改Transform的Scale属性，而要在FBX Import Sttings的Scale Factor菜单中修改其体积。

选定Project视图中的Barrel 3D模型，Inspector视图中会显示FBX Import Settings，选择第一个选项卡Model tap，将Scale Factor的值修改为0.4，然后点击底端Apply进行保存。

注意非均匀刻度（non-uniform scale）

实际游戏开发时，如果要调整从外部导入的所有3D模型的体积，则必须通过FBX Importer Settings修改其Scale Factor属性值。因为如果直接修改Barrel模型的Transform Scale属性，那么游戏运行时，每帧都要生成符合Scale属性值的副本。显然，这种方式下的CPU运算量会增大，成为游戏运行速度低下的主要原因。

调整油桶大小后，为了实现其被子弹击中时的碰撞处理，需要向Barrel添加Capsule Collider和Rigibody组件。添加后，请如下表所示修改Capsule Collider的属性。对于Rigidbody组件，只需将其mass属性设置为20。

| 属性  | 属性值  |
| :------------ | :------------ |
| Center的Y轴  | 1.25  |
| Radius  | 0.8  |
| Height  | 2.5  |
| Direction  | Y-Axis  |

设置酒桶被子弹击中3次时发生爆炸。新建脚本BarrelCtrl，将其添加到Barrel对象。
```cs 
using UnityEngine;
using System.Collections;

public class BarrelCtrl : MonoBehaviour
{
    // 表示爆炸效果的变量
    public GameObject expEffect;
    private Transform tr;

    // 保存被子弹击中次数的变量
    private int hitCount = 0;

    void Start()
    {
        tr = GetComponent<Transform>();
    }

    // 碰撞发生时触发的回调函数
    void OnCollisionEnter(Collision coll)
    {
        if (coll.collider.tag == "BULLET")
        {
            // 删除子弹
            Destroy(coll.gameObject);

            // 累加油桶被子弹击中的次数，3次以上则触发爆炸
            if (++hitCount >= 3)
            {
                ExpBarrel();
            }
        }    
    }

    // 实现油桶爆炸的函数
    void ExpBarrel()
    {
        // 生成爆炸效果粒子
        Instantiate(expEffect, tr.position, Quaternion.identity);

        // 以指定原点为中心，获取半径10.0f内的Collider对象
        Collider[] colls = Physics.OverlapSphere(tr.position, 10.0f);
        
        // 对获取的Collider对象施加爆炸力
        foreach (Collider coll in colls)
        {
            Rigidbody rbody = coll.GetComponent<Rigidbody>();
            if (rbody != null)
            {
                rbody.mass = 1.0f;
                rbody.AddExplosionForce(1000.0f, tr.position, 10.0f, 300.0f)
            }
        }
        
        // 5秒后删除油桶模型
        Destroy(gameObject, 5.0f);

    }
}
```

BarrelCtrl脚本可使油桶被子弹击中3次时爆炸，并产生粒子效果，然后对以该油桶原点为中心，半径10.0f内的物体施加爆炸力。

碰撞发生时触发的OnCollisionEnter函数判断hitCount变量的值是否达到3，若达到则调用ExplosionBarre()函数，此函数以爆炸原点为中心，使用Physics.OverlapSphere()函数获取爆炸效力波及半径内的游戏对象。

利用Physics.OverlapSphere(原点, 半径)函数获取的游戏对象必须添加Collider组件，该函数的返回值为Collider类型的数组。为了将爆炸力施加到每个物体，脚本使用foreach语句从数组开始循环至结尾，依次对每个物体调用AddExplosionForce函数。

AddExplosionForce函数的参数如下所示。
```cs
Rigidbody.AddExplosionForce(爆炸力大小, 原点, 半径, 向上的力);
```
将脚本中的爆炸效果添加到Inspector视图的Standard Assets/Particles/Legacy Particles/explosion。Unity 5中新的爆炸效果默认含有模拟物理爆炸力的脚本，因此，为了应用上述脚本，需要先如下图所示，取消ExplosionPhysicsForce的勾选。

将层次视图的Barrel拖曳到Prefabs文件夹，使之成为预设。复制多个油桶并将其摆放到场景中。运行游戏，发射子弹使油桶爆炸。

# 随机使用纹理
 
油桶预设复件会有相同纹理，而该油桶模型提供了3个纹理。可以编写脚本，使油桶随机使用其中之一。

在Mesh Renderer组件中指定纹理，如下图所示，子对象Barrel模型已经激活Mesh Renderer组件，而父对象Barrel模型是空的游戏对象。

虽然可以在界面上直接设置Mesh Renderer的纹理属性，然后在脚本中更改纹理。但此处使用在脚本中直接随机设置纹理的方式，代码如下所示。
```cs 
using UnityEngine;
using System.Collections;

public class BarrelCtrl : MonoBehaviour
{
    // 表示爆炸效果的变量
    public GameObject expEffect;
    // 要随机选择的纹理数组
    public Texture[] textures;

    private Transform tr;

    // 保存被子弹击中次数的变量
    private int hitCount = 0;

    void Start()
    {
        tr = GetComponent<Transform>();

        int idx = Random.Range(0, textures.Length);
        GetComponentInChildren<MeshRenderer>().material.mainTexture = textures[idx];
    }
}
```

首先，声明要保存适用于油桶的各种纹理的数组。

Start函数中，Random.Range()函数随机生成访问textures数组的Index值，获取子Barrel游戏对象的Mesh Renderer组件，然后将该组件的材质属性设为textures数组中保存的某个纹理。

GetComponentnChildren<T>()函数可获取子游戏对象的T类型的组件，该函数只返回1个组件对象。如果需要返回多个组件对象，请使用GetComponentsInChildren<T>()函数。