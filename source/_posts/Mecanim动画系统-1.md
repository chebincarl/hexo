---
layout: title
title: Mecanim动画系统
date: 2019-04-15 13:38:46
categories: Unity
tags: Unity5.X 完全自学手册
---
旧版动画系统仍在一些特殊场合下被采用，一种情况是使用参数而不是时间来控制动画片段，例如控制瞄准角度等。

<!--more-->

# 简介

Mecanim动画系统为我们提供了最主要的5大功能：

* 1.通过不同的逻辑连接方式，来控制不同的身体部位运动的能力。

* 2.将动画之间的复杂交互作用管理，可视化地展现出来，是一个可视化的编程工具。

* 3.针对人形角色的简单工作流以及动画的创建能力进行制作。

* 4.具有能把动画从一个角色模型直接应用到另一个角色模型上的Retargeting运动重定向功能。

* 5.针对Animation Clips动画片段的简单工作流，针对动画片段以及它们之间的过渡和交互过程的预览能力。

## 术语

Mecanim工作流可以被分解为3个主要阶段。

** 1.资源的准备与资源的导入 **

这一阶段的资源准备一般是由Maya、3ds Max等第三方工具来完成的，即资源的准备这一步骤与Mecanim动画系统没有关系。而资源的导入阶段按照Unity的传统导入方式导入即可。

** 2.角色的建立 **

Mecanim动画系统主要有以下两种角色建立方式：

（1）人形角色的建立

Mecanim动画系统通过扩展的图形操作界面和动画重定向功能为人形模型提供一种特殊的Mecanim工作流，它包括Avatar的创建和对Muscle Definitions肌肉定义的调节。

（2）一般角色的建立
这是为处理任意的运动物体和四足物体而设定的。动画重定向功能对此并不适用，但仍可使用Mecanim动画系统的其他功能。

** 3.角色运动 **

这里包括设定动画片段及其相互间的交互作用，也包括建立状态机和混合树、调整动画参数以及通过代码控制动画播放等。

## 角色导入及Animators工作原理

** 1.获取人形网格模型方法 **

（1）人形网格模型

需要一个带有骨骼绑定和己蒙皮的人形网格模型。

①我们俗称的建模Modelling，即创建一组由多边形面或者三角面网格组成的模型。

②骨骼绑定可以理解为：为了控制角色的运动动画，从而必须为其创建一个骨骼关节层级，该层级定义了网格内部的骨骼结构以及其相互运动的关系，通过控制这个骨骼关节层级，我们就可以成功地创建出骨骼的运动动画。这个过程被称为骨骼绑定Rigging。

③角色的蒙皮操作，即将人形网格模型与关节层级关联起来，通过指定关节的动画来控制该模型的特定网格运动动画，这个过程被称为蒙皮Skinning。

** （2）获取模型 **

在Mecanim动画系统中，可以通过三种途径来获取人形网格模型（人形网格模型导入后Inspector窗口如下图所示）

①使用比如Poser、Makehuman或者Mixamo等的过程式的人物建模软件，其中一些软件可以同时进行骨骼绑定和蒙皮操作，如Mixamo，但是另外的一些则不能。使用这些软件时，应在软件中尽量减少人形网格的面片数量，以方便人形网格模型在Unity中更好地被使用。

②可在Unity Asset Store上购买适当的模型资源。

③使用3ds Max、Maya、Blender等建模软件，从头创建全新的人形网格模型，包括骨骼绑定以及角色蒙皮等。

（3）模型的导出以及确定模型的正确性

Unity允许我们导入一系列的常用3D文件格式，推荐使用.FBX的导出文件格式，该格式有三大优势：

* 导出的网格中可以包含关节层级、法线、纹理以及动画信息。
* 可以将网格模型重新导入建模软件，以验证模型各项参数及纹理、法线、骨骼、蒙皮等的正确性。
* 可以直接导出不包含网格的动画信息。

** 2.导入角色模型动画方法 **

首先需要将该模型动画导入到项目工程中来。Unity支持的格式有原生的Maya文件、.ma或者.mb、Cinema 4D文件以及一般的.FBX文件，请根据需要调整成相应的格式后，再导入到Unity中。在导入动画的时候，只需将模型直接拖动到工程面板中的Assets文件夹，然后选中该文件后，就可以在Inspector视图的Import Settings面板中，编辑该模型的导入设置。

** 3.Animations面板 **

如下图所示，在Inspector视图的Import Settings面板中,有一个Animations的子面板,该面板的主要作用是可对模型的动画片段进行编辑。

一个角色动画模型一般来说都会有一系列的可在不同情景下被触发的基本动作片段，例如走、跑、跳、投掷和死亡等，这些基本的动作片段被称为动画片段Animation Clips。根据角色动画的具体要求，上述基本动作可以被分别导入为若干个独立的动画片段，也可以被导入为按固定顺序播放各个基本动作的单一动画片段。对于后者来说，大家使用前必须在Uniy内部将该单一的模型动画分解为若干个子片段，这个过程是通过Animations面板来完成的。下面就详细讲解下Animations面板的具体使用方法。

（1）使用预分解的动画模型

最容易使用的动画模型是含有预分解动画片段的模型，对于这样的情形，在动画导入面板中会出现Animations面板，该面板中含有一个可用的动画片段列表，可以单击面板底部的“Play”按钮来预览每个动画片段。如果有需要，还可以对每个片段的帧数范围进行编辑和调整。

（2）使用未分解的动画模型
    
对于只提供单一连续动画片段的角色模型，动画在导入面板中会出现如下图所示的界面。在这种情况下，可以自行编辑设定每个动画序列的帧数范围，如行走、奔跑等。具体操作是，通过单击Clips标签下的“+”按钮，进而可以指定包含的帧数范围，这样便可增加一个新的动画片段，同时可通过下方标签栏修改该片段的名字，如下图所示。

①行走动画的帧数范围是1-33f，则添加新片段，并将帧数范围进行设置。
②跑步动画的帧数范围是41~57f，则添加新片段，并将帧数范围进行设置。
③跳跃动画的帧数范围是81~97f，则添加新片段，并将帧数范围进行设置。

(3)给角色模型添加动画片段

用户可以为任意角色模型的动画组件添加动画片段。该模型甚至可以没有肌肉定义，即非Mecanim模型。进而在Animations属性中指定一个默认的动画片段和所有可用的动画片段。在非Mecanim模型上加入动画片段也必须采用非Mecanim的方式进行，即将Musele Definition属性设置为None。

而具有肌肉定义的Mecanim模型，其处理过程如下所示。

①创建一个新的Animator Controller。
②打开Animator Controller窗口。
③将特定的动画片段拖动到Animator Controller窗口。
④将模型资源拖入到Hierarchy视图中。

（4）通过多个模型文件来导入动画片段

另外一种导入动画片段的方法是遵循Unity指定的动画文件命名方案。用户可以创建独立的模型文件并按照modelName@animation- Name.fbx的格式命名。例如，对于一个名为goober的模型，用户可以分别导入奔跑、跳跃、攻击等动画，并分别命名为modelName\@run.fbx、modelName\@jump.fbx和modelName\@attact.fbx。在这种情况下，只有这些文件中的动画数据才会被使用，如下图所示。

在图中，Unity将自动导入这四个动画文件并将其中包含的动画信息搜集到不带有@符号的文件中，而modelName.mb文件则被用于索引上述四个动画文件。对于FBX文件，可以通过勾选no animation选项来只导出模型文件，例如 modelName.fbx，进而通过导出关键帧动画来得到各个动画片段，即四个modelName\@animname.fbx文件。


# 使用人形角色动画

在导入了角色模型和动画片段以及正确设置了Avatar以后，即可在游戏中使用它们。

Mecanim动画系统特别适合于人形角色动画的制作，人形骨架是在游戏中普遍采用的一种骨架结构。Unity为其特别提供了一个特殊的工作流和一整套扩展的工具集，由于人形骨骼结构的相似性，用户可以实现将动画效果从一个人形骨架映射到另外一个人形骨架上去，从而实现动画重定向功能。除去极少数情况之外，人形模型均具有相同的基本结构即头部躯干、四肢等，Mecanim动画系统正是充分利用了这一特点来简化骨骼绑定和动画控制过程。创建模型动画的一个基本步骤就是建立一个从Mecanim动画系统的简化人形骨架结构到用户实际提供的骨架结构的映射。这种映射关系被称为Avatar。Avator的配置界面如下图所示。

## 创建Avatar

如下图所示，导入一个角色动画模型之后,可以在Import Setting面板的Rig选项中指定它的骨骼类型，包括Humanoid、Legacy以及Generic3种模式。

** 1.Humanoid人形动画 **

对于一个人形骨架，单击AnimtionType右侧的下拉菜单，然后选择Humanoid选项。选择之后，单击“Apply”按钮，之后Mecanim动画系统会自动将用户所提供的骨架结构与系统内部自带的简易骨架结构进行匹配。这一步骤由Mecanim动画系统自动完成，如果匹配成功，Avatar Definition下的Configure...选框会被选中，同时在Assets文件夹中，一个Avatar子资源将会被添加到模型资源中。

但这里所说的匹配成功只是表示成功匹配了所有必要的关键骨骼，如果想要达到更佳的效果，还需要使一些非关键骨骼也匹配成功并且模型处于正确的T-pose形态。另外还需针对Avatar进行手动调整。

此外，Mecanim动画系统没有成功匹配创建出该Avatar，那么在Avatar Definition下的Configure...复选框会显示一个叉号，需在这种情况下对Avatar进行手动配置。

** 2.Generic和Legacy非人形动画 **

Unity的Mecanim动画系统为非人形的动画提供了两个选项：一般动画类型和旧版动画类型。一般动画仍可由Mecanim系统导入，但无法使用人形动画的专有功能。旧版本动画则使用Unity4.0版本之前推出的老动画系统。

## 配置Avatar

Unity中的Avatar是Mecanim动画系统中极为重要的模块，因此为模型资源正确地设置Avatar也就变得至关重要。不管Avatar的自动创建过程是否成功，用户都需要进入到Configure Avatar界面中去确认Avatar的有效性，即确认用户提供的骨骼结构与Mecanim预定义的骨骼结构已经正确匹配起来，并且模型已经处于T形姿态。如下图所示，当保存了场景信息后，就会看到一个新的、包含反映当前关键骨骼映射信息视图的Avatar配置面板。

在单击“Confgure...”按钮后，编辑器会要求保存当前场景。这是因为在Configure模式下，可以看到在Scene视图中，将会显示出当前选中的角色动画模型的骨骼、肌肉和动画信息以及相应的参数，而不是再显示游戏场景的视图。在这个视图中实线圆圈表示的是Avatar必须匹配的，而虚线圆圈则表示Avatar可选匹配的：因为虚线圆圈示意的部分会根据实线圆圈示意部分的状态，来自动进行差值计算。所以为了Mecanim动画系统能更好地匹配骨骼，前期提供的骨架中要含有所有必须匹配的骨骼，即实线圆圈示意的部分。

值得注意的是，为了提高匹配的效率，用户应尽量通过标准的命名方式进行骨骼的命名，如右手前臂命名为RightForearm等。尽量通过骨骼代表的部位的英文名称来给骨骼命名。

游戏开发者在制作同时应注意，在骨骼匹配的过程中，经常会遇到无法为模型找到合适的匹配结果的情况。当遇到这种情况时，我们可以通过以下方法来进行手动配置，该方法其实与Mecanim内部使用的匹配方法类似。

1.如下图所示，单击属性栏中的Pose菜单栏下的“Sample Blind-pose”按钮，使模型回到原始的状态。
2.如下图所示，单击Pose菜单栏旁的Mapping菜单，选择Automap选项，创建一个新的骨骼映射。
3.如下图所示，最后单击属性栏中的Pose菜单栏下的“Enforce T-pose”按钮，使模型贴近T形姿态。

如果在第二个步骤中，自动映射局部失败，或者全部失败。用户还可以使用从Scene视图中将骨骼拖出并重新制定骨骼的方法。如果匹配成功，骨骼将在Avatar配置面板中以绿色显示；如果匹配不成功，将以红色显示。也会出现一种情况是，骨骼指定正确，但是角色模型并没有处于正确的位置，这时可以通过Enforce T-pose或者直接旋转骨骼至T形姿态。

对于Avatar配置还可以被保存成一个HumanTemple File人形模版文件，拓展名为.ht，这样只需进行一次手工映射即可，从而节约大量的时间。

## BodyMask（身体遮罩）

Mecanim动画系统通过BodyMask（身体遮罩），用户可以选择性地控制角色身体的某一部分是否受到动画的影响。

在Mesh Import Inspector的Animation选项卡以及Animation Layers面板中找到Body Mask控制选项，来控制动画的局部更新。Mecanim动画系统的这一功能可以满足一些特殊的需求，比如，在游戏中角色的奔跑动画既包含手臂运动又包含腿部运动，如果需要该角色模型在奔跑的时候举着一把枪，那么手臂就不会来回摆动，这时就需要用户在Body Mask中禁止手臂运动即可。Body Mask可以控制角色身体的头部、右臂、左臂、右手、左手、右腿、左腿和根节点，还可以通过单击Avator的某一部分来开启或者关闭IK功能，或者双击空白区域来开启或者关闭所有部分的IK功能。

## 人形动画的重定向功能

在Mecanim动画系统中，人形动画的重定向功能是非常强大的，因为这意味着用户只通过很简单的操作就可以将一组动画应用到各种各样的人形角色模型上。由于重定向功能只能应用到人形模型上，所以为了保证应用之后的动画效果，我们必须正确地配置Avatar。下面主要介绍的是在使用人形动画重定向功能这一过程的方法与步骤。

1.在使用Mecanim动画系统时，Scene场景中应该包含以下的元素。

（1）导入含有Avatar的角色模型。
（2）确定含有Animator组件，其中引用了一个Animator Controller资源。
（3）实例化一组被Animator Controller引用的动画片段。
（4）绑定用于角色动画的脚本。
（5）确定含有角色相关组件，比如CharacterController等。

2.场景中建立另外一个含有Avatar的角色模型。

（1）在Hierarchy视图中建立一个包含角色相关组件的GameObject。
（2）将创建好的角色模型和Animator组件拖动到GameObject中，使其变成GameObject的子物体；同时检查引用到Animator的脚本是否在子节点中查找Animator，如果不是，需要修改脚本中的代码为GetComponentInChildren<Animator>();，而不是使用GetComponent<Animator>()在根节点中查找。

3.完成以上两步之后，需要在另一个模型上按如下方法重用角色动画。

（1）关闭原始角色模型。
（2）如下图所示，将所需要的模型拖动到创建好的GameObject中，使其成为GameObject的另外一个子物体

4.检查新模型上的AnimatorController属性是否引用了与原始角色模型相同的Controller资源。

5.调整GameObject的CharacterController、Transform及其他属性，确保原来的动画片段能在新模型上正常工作。

6.如下图所示，为完成效果动作图。

## 非人形动画

Mecanim动画系统还支持非人形动画，非人形动画在Unity中被称为一般动画。一般动画的使用方法是：在Assets文件夹中选中模型文件，在Inspector属性视窗中的Import Settings属性面板中选择Rig标签页，并单击Animation Type选项右侧的列表框，选择Generic或者Legacy动画类型，如下图所示。

# 在游戏中使用角色动画

游戏开发者在正确导入角色模型和动画片段并且正确配置好Avator之后，就可以在游戏中使用它们了。在Meanim动画系统中控制和顺序播放角色动画的使用方法，将会在接下来的内容中介绍。

## Mecanim系统逆向运动学功能

IK与FK对应，正向运动学就是根骨骼带动节点骨骼运动。而反向运动学就是反过来，由子节点带动父节点运动。

对于Humanoid的动画，使用的方法很简单，在Animator窗口中，对于要使用1K的动画状态勾选Foot IK选项，在Base Layer中勾选IK Pass选项。然后在代码中实现OnAnimatorlK函数来控制IK。

KCtrl示例代码如图7-17所示。

在3ds Max中使用IK的情景还是非常多的。比如一个小章鱼，在其每只脚绑上IK，然后就可以通过脚步移动控制整条腿的运动。如果不用IK的话，要使角色运动起来很麻烦，而且不自然， FBX的格式里面同样存储有1K信息，只是Unity过滤了相关的数据。大家在导出动画之前做这样的操作，动画即可正常显示。

在3dsMax中按【Crl】+LA1键选中所有骨骼，在右侧的选项卡中执行Motion-Trajectories命令，如果已经选择好骨骼， "Collapse"按钮就可以正常单击，单击这个按钮，然后正常地导出动画。这样Unity中的动画表现就跟3ds Max中的一致了。

值得注意的是，使用Collapse功能会修改动画的帧(使帧间隔变得一样)，这样我们很多动作播放的时候就会被改变，比如攻击动作会变得很慢，没有力度。美工应该在Collapse后再次修改动画(或者是在制作动画之前使用Collapse)以保证动画的正确性。

## Animator组件

Animator组件是关联角色及其行为的纽带。每一个含有Avatar的角色动画模型都需要有一Animator组作。 Animator组件引用了一个Animator Controller用于为角色设置行为，包括StateMachines状态机、Blend Trees混合树以及通过脚本控制的Events事件。其具体内容如表7-1所示。

7-1 Animator组件中文名与功能详解
选项英文名称Controller
选项中文名称
功能详解
控制器
Avata
Apply Root MotionAnimate PhysicsCulling Mode
关联到该角色的Animator控制器
Mecanim动而系统的备化人形世架结构到该角色的骨架结构的映射是使用动画本身还是使用脚本来控制角色的位置
动面是否与物理属性交互
骨架结构的映射应用RootMotion选项动画的物理选项动画的裁剪模式
决定动画是否核剪以及技剪的模式
Always aninate: 总是雇用动面，不进行被剪
Based on Renderers:当看不见角色时只有根节点运动，身体的其他能外保持静止

## Animator Controller

Animator Controller被用于显示和控制角色的行为。详细地说，是通过在Project规图中执行Create-Animator Controller命令来创建的，同时会在Assets文件夹内生成一个后缀名为。controller的文件。当设置好运动状态机后，就可以在Hierarchy视图中将该Animator Controller拖入到含有i Avatar的角色模型的Animator组件上。

Animator Controller窗口包括内容如图7-18所示。

值得注意的是， Animator Controller 口总是显示最近被选中的后缀名为
ler资源的状态机，与当前所载入的场景无关。

## Animator动画状态机

一个角色拥有多个可以在游戏中不同状态下调用的不同动作是一件很普遍的事。例如，一个角色可以在等待时呼吸或者摇据在得到命令时行走或者从一个平台掉落时惊慌地伸手。当这些动画进行回放时，使用脚本控制它们可能是一个潜在的复杂工作。Meccanim动画系统借用了计算机工程师熟知的一个概念-状态机，来简单的控制和序列化角色动画。如图7-19所示，为Animator动画状态机原理图。

值得游戏开发者注意的一个最基本的观点是:一个角色应该在任何给定的时刻执行某些特定的动作，这些动作是否可用，是基于游戏进程的，但是典型的动作包括等待、移动、跑动、路跃等。这些动作被称为状态。在场景中当角色正在行走、等待或者做其他什么的时候都会处于某一个状态。

一般来说，角色在进入下一个状态时会被限制，而不是可以从任意一个状态跳转至另一个任意状态。比如，一个“跑动跳跃”动作只可以在角色正在跑动时执行而不是当角色正在站立的时极执行。你永远不应该从等待动作中直接跳转到跑动跳跃动作，让角色正确跳转状态的选项被称为状态转移。而将上面这些(状态的集合、状态转移的集合和一些用于记录正确状态的变量)整合起来的东西就是一个状态机，

状态机对于动画的重要性在于它们可以很简单地通过相对较少的编码完成设计和更新，每个状态都有一个当前状态机在那个状态下将要播放的动作集合。这将允许动画师和设计师不使用代码而定义可能的角色的动画和动作序列。

Mecanim的动画状态机提供了一种可以预览某个独立角色的所有相关动画剪辑集合的方式，并且允许你能够在游戏中通过不同的事件触发不同的动作，

如图7-20所示，动画状态机可以通过动画状态机窗口进行设置。

状态机包括状态、状态转移和事件，并且在大的状态机中可以设置一个小的子状态机。具体包含内容如表7-2所示。