---
layout: title
title: 制作子弹发射效果-3
date: 2019-04-01 13:49:09
categories: Unity
tags: Unity5权威讲解
---
思考并回答以下问题：
1.如何制作子弹尾迹？
2.粒子系统如何使用？

<!--more-->

本章涵盖：
* 制作子弹发射轨迹：Trail Renderer
* 应用粒子系统

# 制作子弹发射轨迹：Trail Renderer

RPG游戏中，可以经常看到主人公角色挥剑时和发射子弹时的轨迹效果。这种视觉效果增加了游戏的趣味性，对于打击感的提升也有很大帮助。

实现这种效果的方式有很多，其中最常用的方法是在子弹移动的同时动态生成网格，然后在一定时间后删除网格。Unity提供了可以轻松处理动态生成网格的Trail Renderer组件，使用此组件可以更好地表现发射子弹的轨迹视觉效果。

在Hierarchy视图中选定Bullet预设，点击菜单Component->Effects->Trail Renderer添加Trail Renderer组件。添加组件后，拖曳Bullet预设使之向Z轴方向前进，可以看到Unity生成的动态网格。此时，如果将场景视图中的渲染模式更改为Shaded Wireframe，即可同时看到纹理和网格的形态，如下图所示。

{% asset_img 1.jpg %}

动态生成的网格在Scene视图中的颜色如果是粉色，则表示尚未为其设置材质，所以需要先生成Trail Renderer需要的材质，然后为其设置纹理。

把Trail.png文件拖曳到Project视图 Images文件夹，并在Images/Materials/下新建BulletTrail材质。

将新建的BulletTail材质的着色器设置为Particle/Additive，并为该着色器Particle Texture属性设置纹理为Trail.png文件。

{% asset_img 2.jpg %}

将Bullet对象的材质属性的子属性Elements 0设为BulletTrail，场景视图中的粉红色网格就会被该纹理覆盖，也可以直接将BulletTrail材质拖曳到Scene视图中的粉红色网格。

{% asset_img 3.jpg %}

如前所述，Trail Renderer组件具有Time属性，使用其即可动态生成网格，经过一定时间后还会自动去掉该动态网格。请将Time属性值改为0.3，Start Width值为0.2，End Width值为0.01，子弹的拖尾看上去会越往后越尖锐。

> Trail Renderer的主要属性

| Trail Renderer属性  | 说明  |
| :------------ | :------------ |
| Time  | 动态生成的网格的持续时间  |
| Start Width  | 网格头部宽度  |
| End Width  | 网格尾部宽度  |
| Colors  | 材质的纹理颜色，Unity可以处理5个层次的渐变颜色效果  |
| Min Vertex Distance  | 设置动态生成的网格间隔，数值越低，网格越密集  |
| AutoDestruct  | Time时间过后，删除使用Trail Renderer的游戏对象  |

本示例中，Trail Renderer的Min Vertex Distance属性值需要调整。<span style="color:red;">如果物体沿直线运动，则需要设置较大的值以减少动态生成的网格数量；如果物体进行抛物线运动，则需要设置较小的值以使轨道看上去更平滑。</span>

{% asset_img 4.jpg %}

Trail Renderer组件的Time属性值越大，轨迹持续时间越长，子弹后面的“尾巴”也越长。

# 应用粒子系统

下面学习如何实现子弹碰撞墙壁时产生的火花效果。游戏中，火焰、火、烟等效果主要使用粒子系统实现。Unity通过粒子系统生成覆盖纹理的网格，然后使之以一定速度移动，表现上述效果。

但游戏在短时间内使用太多粒子会给引擎带来较高的负荷，因此，实际开发中需要适当使用。然而，为了提高游戏的打击感和视觉效果，使用粒子又是必须的，所以需要考虑如何在不带来太多负荷的情况下展现期望的视觉效果。

首先导入Unity默认提供的粒子资源包，鼠标右击Project视图，选择上下文菜单的Import Package->Particles，或者选择Unity主菜单的Assets->Import Package->Particles进行导入。如下图所示，需要选中并导入粒子系统资源包中的所有文件夹。

导入后，粒子资源包将安装到Project视图的Standard Assets Particles文件夹。

** 脚本编译优先顺序 **

导入的粒子资源包中的Standard Assets文件夹是Unity默认提供的资源包文件夹，该文件夹中的脚本将会比其他脚本被优先编译。

Unity中可以自定义脚本编译顺序。选择菜单的Editor->Project Settings->Script Execution Order，或者选择脚本并在Inspector视图中点击按钮Execution Order，即可打开MonoManager进行设置。

MonoManager中可以自行指定各脚本编译顺序。

{% asset_img 5.jpg %}

子弹与墙壁碰撞时发生的粒子效果需要在墙体脚本中处理，修改WallCtr脚本。

> WallCtrl：添加粒子效果

```cs
using UnityEngine;
using System.Collections;

public class WallCtrl : MonoBehaviour
{
    // 表示火花粒子对象的变量
    public GameObject sparkEffect;

    // 碰撞开始时触发的事件
    void OnCollisionEnter(collision coll)
    {
        // 比较发生碰撞的游戏对象Tag值
        if (coll.collider.tag == "BULLET")
        {
            // 动态生成火花粒子
            Instantiate(sparkEffect, coll.transform.position, Quaternion.identity);
            // 删除发生碰撞的游戏对象
            Destroy(coll.gameObject);
        }    
    }
}
```
Instantiate函数可用于动态生成粒子，参数中的position为子弹碰撞墙体时的位置，第三个参数角度需要设置为Quaternion.identity，用于生成不会旋转的粒子。
```cs 
// 动态生成火花粒子
Instantiate(sparkEffect, coll.transform.position, Quaternion.identity);
```

选择Project视图的Wall预设，将WallCtrl脚本中的Spark Effect变量设为Flare预设。

{% asset_img 6.jpg %}

Flare预设默认是无限循环的，在Project视图中选择Flare预设即可查看Inspector视图的粒子系统组件的各个属性。如下图所示，点击Open Editor...可以打开粒子效果编辑窗口。

{% asset_img 7.jpg %}

Flare预设由Flare、Smoke、Spark这3个粒子效果组成，该预设有很多属性，其中Duration属性为0.3，Looping属性默认不勾选，Duration属性决定了粒子效果持续显示的时间，Looping属性则决定了是否循环显示粒子效果。

{% asset_img 8.jpg %}

修改Flare粒子效果的属性并运行游戏，左击鼠标向墙壁发射子弹，可以看到子弹与墙壁碰撞的同时出现了火花四射的效果。

子弹与墙壁碰撞后，粒子效果持续0.3秒并消失，但Hierarchy视图中仍然会留下粒子预设的复件。因此，需要编写脚本使引擎在一定时间后强制删除动态生成的Flare预设。修改WallCtrl脚本的火花生成部分。

> WallCtrl：一定时间后删除Flare预设

```cs
using UnityEngine;
using System.Collections;

public class WallCtrl : MonoBehaviour
{
    // 表示火花粒子对象的变量
    public GameObject sparkEffect;

    // 碰撞开始时触发的事件
    void OnCollisionEnter(collision coll)
    {
        // 比较发生碰撞的游戏对象Tag值
        if (coll.collider.tag == "BULLET")
        {
            // 动态生成火花粒子并将其保存到变量
            GameObject spark = (GameObject)Instantiate(sparkEffect, coll.transform.position, Quaternion.identity);
            // 经过ParticleSystem组件的duration时间后删除
            Destroy(spark, spark.GetComponent<ParticleSystem>().duration + 0.2f);

            // 删除碰撞的游戏对象
            Destroy(coll.gameObject);
        }    
    }
}
```
Instantiate函数的返回类型为Object，脚本将其转换为GameObject类型。换言之，将动态生成的Flare预设保存到spark变量。脚本将火花粒子的持续时间在ParticleSystem组件的duration属性值基础上再追加了0.2秒，这样可以使火花产生掉落到地面上的效果。
```cs 
// 动态生成火花粒子并将其保存到变量
GameObject spark = (GameObject)Instantiate(sparkEffect, coll.transform.position, Quaternion.identity);

// 经过ParticleSystem组件的duration时间后删除
Destroy(spark, spark.GetComponent<ParticleSystem>().duration + 0.2f);
```