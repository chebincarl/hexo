---
layout: title
title: 创建人物-2
date: 2019-04-10 16:27:38
categories: Unity
tags: Unity5.X游戏开发指南
---
本章涵盖
* 反向动力学

<!--more-->

# 反向动力学

首先大致介绍正向动力学和反向动力学的概念。

* 正向动力学（Forward Kinematics, FK）
指骨骼的旋转和移动都是由父骨骼决定的。例如肩膀驱动手臂、手臂驱动手腕、手腕驱动手掌和手掌驱动手指。

* 反向动力学（Inverse Kinematics, IK）
指骨骼的旋转和移动会对父骨骼产生影响。通俗地说，当角色看到面前有一个苹果时，角色的手掌就知道如何运动并到达苹果的位置拿到苹果，而手掌再驱动手腕，把手腕“拉”过去，手腕再驱动手臂，手臂再驱动肩膀。任何人形骨骼都支持IK，适用于以下动作。
    * 控制身体一只手臂或者一条腿的位置。
    * 控制身体一只手臂或者一条腿的旋转。
    * 控制头看向某点。
 
第一步：开启Layer的IK通道。如下图所示，点击齿轮后在弹出的窗口中勾选“IK Pass”，开启后会在齿轮的左侧显示“IK”字样。当开启iKPass后，会在每一帧里调用MonoBehaviour的OnAnimatorIK()函数。IK的处理也只能在OnAnimatorIK()函数里。

{% asset_img 19.png %}

第二步：设置权重，参数为0至1之间的浮点数，一般设置为1。
```cs
animator.SetIKPositionWeight(1);
animator.SetIKRotationWeight(1);
animator.SetLookAtWeight(1);
```

第三步：设置。
```cs
Animator.SetIKPosition
Animator.SetIKRotation
Animator.SetLookAtPosition
```

角色上绑定的IKCtrl脚本代码如下：

```cs
using UnityEngine;
using System;
using System.Collections;

// 要求游戏对象必须有Animator组件
[RequireComponent(typeof(Animator))]
public class IKCtrl: MonoBehaviour 
{
	private Animator animator;
	// IK的开关
	public bool iKPositionActive;
	public bool iKLookAtActive;
	public bool iKRotationActive;

	// SetIKPosition和SetLookAtPosition的对象
	public Transform rightHandObj;

	// SetIKRotation的对象
	public Transform rightHandRotationObj;

	void Start ()
	{
		animator = GetComponent<Animator>();
	}

	void OnAnimatorIK()
	{
		if(iKPositionActive)
		{
			// 当开启IK位置时
			// 设置右手的IK位置权重为1
			animator.SetIKPositionWeight(AvatarIKGoal.RightHand, 1.0f);
			// 设置右手的IK位置为rightHandObj的位置
			animator.SetIKPosition(AvatarIKGoal.RightHand, rightHandObj.position);
		}else
		{
			// 当不开启IK位置时，重置IK位置的权重为0
			animator.SetIKPositionWeight(AvatarIKGoal.RightHand, 0f);
		}
		
		if(iKLookAtActive)
		{
			// 当开启IK的LookAt时
			// 设置IK的LookAt权重为1
			animator.SetLookAtWeight(1); 
			// 设置头部看向rightHandObj
			animator.SetLookAtPosition(rightHandObj.transform.position);
		}else
		{
			// 当不开启IK的LookAt时，重置IK的LookAt的权重为0
			animator.SetLookAtWeight(0f);
		}

		if(iKRotationActive)
		{
			// 当开启IK旋转时
			// 设置右手的IK旋转权重为1
			animator.SetIKRotationWeight(AvatarIKGoal.RightHand, 1.0f);
			// 设置右手的IK旋转角度为rightHandObj的旋转角度
			animator.SetIKRotation(AvatarIKGoal.RightHand, rightHandObj.rotation);
		} else 
		{
			// 当不开启IK旋转时，重置IK旋转的权重为0
			animator.SetIKRotationWeight(AvatarIKGoal.RightHand, 0f);
		}	
	}
}
```
运行场景，通过角色的Inspector视图里的3个开关控制角色IK。当勾选iKPositionActive时，如果球体位于角色右手能到达的位置，角色的右手的手腕部位等于球体的位置，如球体位于角色右手不能到达的位置，右手会伸向球体。当勾选iKLookAtActive时，角色会一直看向球体。当勾选iKRotationActive时，角色右手手腕的旋转角度等于圆柱体的旋转角度，同时带动调整整个右臂的角度。

但是我们还需要注意Unity中IK的限制，AvatarIKGoal也就是IK的目标只有RightHand、LeftHand、RightFoot和LeftFoot这4种，而且IK是某个身体部分（比如右臂）的反向动力学，并不是全身的。

IK可以实现很多效果，比如角色开枪后由后座力引起的手臂的抬起效果、抓取物体的效果等。