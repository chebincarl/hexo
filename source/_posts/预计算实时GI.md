---
layout: title
title: 预计算实时GI
date: 2019-05-22 14:48:01
categories: Unity
tags: 大话Unity2018
---
思考并回答以下问题:
1

<!--more-->

前两天我们学习了场景准备的相关工作，今天我们学习Unity光照系统中的预计算实时GI的使用流程。

使用预计算实时GI时，预计算是计算Unity场景中静态物体周围光线的反射并存储此数据以供运行时使用的过程。该过程减少了运行时执行的照明计算次数，允许实时反射光照，同时保持合适的帧率。

如果场景没有经过处理和优化，这些计算所需的时间可能会很长。我们也会学习如何针对Enlighten（Unity的预计算实时GI的后端）优化场景，让照明预计算时长从数小时降低到几分钟。

预计算实时GI的流程一般如下：

场景环境设置

打光

场景中物体的处理

调节预计算实时GI的参数

进行预计算

根据结果调整优化参数，再次进行预计算

前三步我们已经在前两天的课程中详细学习了，今天我们来看一下后面的步骤。

调节预计算实时GI的参数
启用预计算实时GI
默认情况下，在Unity的Lighting窗口（菜单栏 Window > Lighting > Settings）的Scene页签中同时启用了预计算实时GI和烘焙GI。

默认情况下Lighting的设置默认情况下Lighting的设置

要想使用Realtime GI，我们只选中Realtime Global Illumination。

Indirect Resolution（间接光分辨率）
使用实时GI时，第一个需要考虑的就是Indirect Resolution参数。Indirect Resolution设置了一个世界单位使用的实时光照贴图像素的数量。

Indirect Resolution可以在Lighting窗口中查看设置，如下所示：

打开Lighting窗口（Window > Lighting > Settings），然后选择 Scene 选项卡。

选中Realtime Lighting下的Realtime Global Illumination。（一定要选中，否则Indirect Resolution不可修改）

查看Lightmapping Settings中的Indirect Resolution属性。



你可能发现有一些参数是灰色的，无法调整，那是因为那些参数是Baked GI相关的参数，暂时可以忽略。

选择合适的Indirect Resolution
在设置场景时，确定项目的单位比例非常重要。可能是在你的项目中，一个单位是米，一英尺或一厘米。Unity中的1个单位（Unity中的Cube创建出来棱长就是1个单位）并没有确定的物理尺寸，但是通常我们将1个单位理解成1米。

在大多数项目中，建议一个单位=1米，这样与现实世界物理系统的单位相同。例如，在Unity中，重力的默认单位是单位/秒。1个单位=1米是真实世界游戏场景的最佳实践。

通常场景的Indirect分辨率可以根据游戏世界的规模来确定。例如，你的场景是一个小而密的室内环境，在间接照明较为复杂的情况下，更高的Indirect分辨率（例如每个unit 2-3个像素）可以有更多的细节。

也许你的场景是一个大型户外环境，世界规模非常大，可能一个表面就成百上千平方米，而且表面颜色几乎一样（反射光的颜色也不会大幅变化）。这种情况下，适用室内场景复杂情况的的分辨率在这种大型户外环境中是非常浪费的。分辨率过大会浪费宝贵的CPU时间和内存，因为需要保存和更新对场景整体外观没有多大贡献的光照贴图。更重要的是，这会大幅增加预计算时间。

对于室外环境和场景内的大型物体，合适的Indirect分辨率可能介于每单位0.5-1个像素之间；对于大地形为0.1至0.5个像素。

预计算实时GI分辨率 vs 烘焙光照贴图分辨率
Unity中实时GI所需的Indirect分辨率值比传统光照贴图像素密度低几个数量级。因为我们只在这些光照贴图中保存间接照明，通常是非常柔和、“低频”的。使用实时GI时，通常会使用实时阴影而不是高分辨率光照贴图提供清晰阴影。

使用传统光照贴图技术中看似合适的值 - 例如每个单位30个像素 - 可能会导致预计算失败或计算时间过长。对于室内场景，合适的值为每单位2-3个像素，室外环境为0.5-1（这是基于单位尺寸为1单位= 1米的场景。如果场景单位尺寸比例不同，这些值就需要相应调整）。

场景  实时GI合适的分辨率
室内  每单位2 - 3个像素
户外  每单位0.5-1个像素
地形  每单位0.1 - 0.5像素
建议场景中1个单位=1米    
场景的Indirect分辨率也是场景中所有静态对象的默认分辨率。标记为Lightmap Static的MeshRenderer将默认使用此值，除非单独设置MeshRenderer中的Lightmap Parameters（28课最后的选读内容）中的Resolution。

除了为整个场景选择Indirect分辨率之外，还可以通过MeshRenderer中的Lightmap Parameters中的Resolution为每个物体修改光照分辨率。如果需要更高分辨率提供额外保真度，可以增加此值。通常将适合场景大部分物体的分辨率设置为场景默认值，然后手动调高需要更多照明细节的物体的分辨率。

启动预计算
要启动预计算的过程，场景中至少要由一个物体被标记为Lightmap Static。

Lightmap Static标记
上节课学习时，我们提到了GameObject的Lightmap Static标记。

Static菜单Static菜单

开始计算过程
场景中的静态物体设置为Lightmap Static以后，就可以开始预计算的过程了。



打开Lighting窗口，切换到Scene选项卡。

如果Auto Generate（自动生成）复选框是选中的，那么你应该可以在Unity编辑器的右下角看到已经开始计算过程了。

如果Auto Generate复选框没有选中，你可以选中来让编辑器自动生成（场景发生改变时，会自动启动计算）。如果你不想自动生成，可以点击右侧的Generate Lighting按钮来手动生成。

Unity编辑器的右下角会显示进度Unity编辑器的右下角会显示进度

计算的时间可能根据场景的大小以及你的设置的不同从几分钟到几小时不等。等待计算完成后，你就能看到场景发生的变化。

左图中仅用了实时光照，右图加入了预计算实时GI，可以看到间接光让场景看起来更自然了左图中仅用了实时光照，右图加入了预计算实时GI，可以看到间接光让场景看起来更自然了

如果你的场景比较复杂，可能会需要几小时的时间来进行预计算。后面会有针对预计算时间的优化的专门的课程。

总结
今天学习了使用Unity中的光照系统中的预计算实时GI，希望你能记住使用的流程：

场景环境设置

打光

场景中物体的处理

调节预计算实时GI的参数

进行预计算

根据结果调整优化参数，再次进行预计算

今日思考题
构建一个简单场景，试试使用预计算实时GI和仅使用实时灯光的区别~
