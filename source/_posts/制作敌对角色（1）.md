---
layout: title
title: 制作敌对角色（1）
date: 2019-04-13 15:44:41
categories: Unity
tags: Unity5权威讲解
---
敌对角色在游戏中是NPC（Non Playable Character，非玩家角色）的一种，是玩家无法控制的角色。也就是说，其应该具备自己的人工智能，可以在游戏中与玩家互动，这样才会使游戏更加逼真。

<!--more-->

要想实现NPC的人工智能，需要用到有限状态机（FSM，Finite State Machine）。使用有限状态机后，敌对角色便会自动适应周边环境，并对周围发生的事件产生适当反应。本章要制作的敌对角色会在生成后自动在场集中巡查，一旦发现玩家角色便会开始追击。如果追到其射击范围内，便会攻击玩家角色。另外，敌对角色会受伤，如果生命条消耗殆尽就会死亡。

# Mecanim动画系统

为了根据FSM的状态控制敌对角色进行上述反应和动作，需要利用Unity的Mecanim动画系统制作动画。Mecanim动画系统是一种动画中间件引擎，使用其可以轻松制作柔和、平滑的动画效果。

Mecanim动画系统提供了重新设定目标（re-targeting）的功能，如果类人（Humanoid）模型的骨骼构造一致，那么可以直接使用其他模型的动画，或者使用动作捕捉该模型动画以制作自己的动画。随之就可以重复使用其他模型的动画，还可以通过模型的高画质动作捕捉操作以提高自身画质。这是Mecanim的一大优点。

# 导入怪兽3D模型

导入Monster资源包，导入后，将Monster文件夹移到Models文件夹。

这个怪兽模型包含了游戏中需要的基本动画idle、walk、run、jump、fall、attack等，这些动画虽然不是用动画捕捉制作的，但都可以转换为Mecanim类型。

# 转换为Mecanim动画

选择Project视图中的Monster模型后，点击Inspector视图的Rig选项卡，如下图所示。

Rig选项卡中可以设置动画类型，分为Legacy Animation、Generic、Humaniod这3种类型，各类型特征如下表所示。

> 动画类型

| 类型  | 特征  |
| :------------ | :------------ |
| Legacy  | 旧动画系统  |
| Generic  | Mecanim动画系统（非人形模型），无法使用重新设定目标功能  |
| Humaniod  | Mecanim动画系统（人形模型、2足步行模型），可以重新设定目标  |

Monster模型是2足步行（Biped）模型，所以此处选择动画类型为Humaniod。变更动画类型后，不要忘记点击底部Apply按钮保存。点击Apply之后，Unity开始分析当前模型的骨骼结构。一段时间过后，Configure按钮就会激活，按钮前面也会出现确认标记。如果模型不是Humanoid类型的骨骼结构，按钮前会出现X标记，表示不可以在该模型上使用Mecanim分析骨骼结构。

点击Configure按钮，出现Unity映射的骨骼结构图，可以查看骨骼是否映射成功，如下图所示。此时如果弹出保存场景对话框，可以点击按钮进行保存。

Avatar中保存着模型骨架的映射信息，可以反复映射模型信息。

Inspector视图的monsterAvatar呈现了对模型骨骼映射之后的结果，其中15个实线圆圈是必须与模型对应的骨骼连接的节点，而虚线圆圈是附加的节点，可以不与模型连接。因此，即使是看上去完全不同的模型，只要这些实线圆圈代表的骨骼一致，即可重新使用这些模型的动画。

点选Inspector视图中Avatar设置画面顶端Muscles选项卡，可以在该界面拖曳各项条目以活动各个关节。

另外，还可以在Pre-Muscle Settings旋转各个关节，并设置关节可以活动的最小角度和最大角度。

点击Animations选项卡可以看到该模型拥有的动画列表，在此修改各个动画片段的属性。其中Loop Time选项表示当前动画片段可反复播放，而Loop Pose选项可以使动画在反复播放过程中更加平滑、柔和。

如下图所示，如果动画目录中没有动画片段，或者由于误操作而将动画片段删除，此时可以使用之前介绍的将主人公角色进行动画分割的方法依次分割本章节的怪兽动画。

现在已经设置了默认Mecanim属性，请将Monster拖曳到场景视图。

如下图所示，可以将idle、walk、attack、fall这些动画片段依次勾选Loop Time选项，并点击底端Apply按钮保存。

Monster模型使用了Animator组件，该组件是制作敌对角色动画必需的组件，与前面制作Player模型时所需的Animation组件一样。可以靠3D模型中添加的组件类型轻松区分是Mecanim类型的动画还是旧版动画，如下表所示。

> 根据添加组件判别动画类型

| 组件  | 动画类型  | 具体选项  |
| :------------ | :------------ | :------------ |
| Animator  | Mecanim Animation  | Generic<br>Humanoid  |
| Animation  | Legacy Animation  |   |

# 动画控制器

下面为怪兽添加动画。如果为模型制作Mecanim类型的动画，需要Unity提供的动画控制器（Animator Controller）。

动画控制器可以为动画类型是Mecanim的模型制作动画，还提供了界面，可以根据特定条件设计能够转换不同动画状态的规则。

选定Project视图的文件夹，选择Assets->Create->Animator Controller菜单；或者在Project视图的上下文菜单中选择Create->Animator Controller，新建动画控制器New Animator Controller。

将其重命名为MonsterAnim，然后双击，IDE显示Animator视图，如下图所示。Aninmator视图中，可以像使用画图标的工具一样使用wYSIWYG方式拖曳动画片段，以设置Mecanim动画。按下快捷键（Windows: Alt键）并用鼠标拖曳，可以上/下、左/右移动该设计区域。

首次打开Animator视图时，默认生成3个状态图标，其作用如下表所示。表6-3各默认状态的作用
状态分类  作用
Entry  开始状态,状态机最初进人点
Exit  结束状态,所有状态结束的跨态
Any State  无论当前正在以何种状态运行,只要满足条件,都需要分离的任一状态

将项目视图Monster模型下面的动画片段中的idle动画拖曳到Animator视图。如图6-12所示,M添加的动画片段呈橘黄色,表示这是该模型第一个要执行的动画片段,所以Unity自动为它与Entry状态之间添加了一条连接线。

如果想将其他动画片段设为第一个动画片段,需要鼠标右击该动画片段,然后在上下文菜单中选择Set As Layer Default State.

向Animator视图添加的这种动画片段称为State, 而 idle动画片段可称为idle State,

初始动画已设置好,请在层次视图中选择Monster,然后将检视视图内Animator组件的属性设置为新建的动画控制器MonsterAnim.

运行游戏,可以看到怪曾执行了il动面,并且Arinssr规图中的ik图标下端出现动画执行进度条

请注意,如果想在Animator视图中查看动画执行进度条,需要先在层次视图中选定怪售模型。下面添加怪营走路的动画片段,直接掩曳walk动画片段到Aninator图中即可,如图615所示。

# 动画状态转换

要想使怪兽模型从基本动勇idle转换为执行下一个动画walk,需要连接这2个状态。请在idle上右击鼠标,在上下文菜单中选择Make Transition菜单,出现可以连接其他状态的白色连接线。将此线带到walk图标上并点击,即可连接这2个状态. Unity中t,这种连接线称为Transition.