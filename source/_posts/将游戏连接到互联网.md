---
layout: title
title: 将游戏连接到互联网
date: 2019-03-26 09:19:49
tags: Unity
---
本章涵盖
* 使用天空盒为天空生成视觉效果
* 在协程中使用WWW对象下载数据
* 解析诸如XML和JSON这种常见的数据
* 显示从互联网下载的图像
* 将数据发送到Web服务器

<!--more-->

本章将学习如何通过网络发送和接收数据。

Unity支持多种方式的网络通信，因为不同的方式适用于不同的需求。然而，本章将主要介绍最常用的互联网通信：发出HTTP请求。

在Unity中开发围绕HTTP请求建立的在线游戏本质上是和服务器以Ajax方式通信。

Web应用程序和视频游戏中时间的衡量不同。更新一个网站花费半秒看起来很短，但在一个高强度动作游戏中暂停甚至只是半秒的时间都是一种折磨。“快速”这个概念是根据情况定义的。

在线游戏通常连接到该游戏特定的服务器。为了便于学习，我们连接到一些免费且可用的互联网数据源，包括天气数据和可以下载的图像。本章最后部分会要求你设置一个自定义Web服务器。

本章计划介绍HTTP请求的多种用法，以便可以学习它们在Unity中的工作原理：
(1)创建户外场景（特别是，构建一个可以响应天气数据的天空）
(2)编写代码，从互联网请求天气数据
(3)解析响应并基于数据修改场景
(4)从互联网下载并显示图像
(5)将数据发送到服务器（本例中是天气日志）

# 创建户外场景
由于我们将下载天气数据，因此接下来创建一个可以显示天气的户外场景。最复杂的部分是天空，但首先花点时间将户外贴图应用到关卡的几何体上。

从www.cgtextures.com 上获取一些图像，将这些图像应用到关卡的墙壁和地板。记住将下载的图像的大小修改为2的N次幂，例如256256。接着将图像导入到Unity项目中，创建材质，并将图像赋予到材质上（也就是将图像拖动到材质的贴图槽）。将材质拖动到场景中的墙壁或地板上，接着增加材质的平铺（尝试设置平铺的一个或两个方向使用8或9），以便图像不会以丑陋的方式被拉伸。
一旦地板和墙壁处理完毕，就可以开始装饰天空。

## 使用天空盒生成天空视觉效果

首先导入天空盒图像：下载DarkStormy系列和TropicalSunnyDay，将这些贴图导入到Project视图中，并设置贴图的Wrap Mode为Clamp。
现在创建用于这个天空盒的新材质。在这个材质设置的顶部，单击Shader菜单查看可用的着色器（shader）列表，将鼠标移动到Skybox部分并选择子菜单中的6-Slided。随着这个着色器激活，材质现在有6个贴图档（而不像标准材质只有一个小的Albedo贴图槽）。将SunnyDay天空盒图像拖动到新材质的贴图槽中。图像名称和它们赋予的贴图槽名称相对应（top、 front等）。一旦6个贴图都被连接好，就可以将这个新材质用作场景的天空盒。

在Lighting窗口(Window | Lighting)中赋予这个天空盒材质，将天空盒材质赋予到窗口顶部的Skybox槽(将材质拖动到Skybox槽上或者单击Skybox槽旁边的小圆圈按钮),单击Play,则可以看到如图9-1所示的画面。

很好,现在已经拥有一个室外场景!天空盒是一种用于创建一个无际环绕玩家大气环境的错觉的优雅方式。但Unity内置的天空盒着色器有一个明显的限制:天空盒材质的图像不能改变,这导致天空完全是静态。接下来将通过创建自定义着色器来消除这个限制.

9.1.2通过代码设置大气环境
TropicalSunnyDay系列中的图像对于晴天看起来很好,但如果我们想要在晴天和阴天过渡呢?这将需要第二套天空图像(一些阴天的图片),因此需要新的着色器来实现天空盒。如第4章所述,着色器是用于渲染图像的简短的程序指令。这意味着可以编写新着色器,而事实上正是如此。接下来将创建新的着色器,使用两个天空盒图像集并在它们之间过渡,幸运的是,实现这个目的的着色器已经存在于Unify Community维基的脚本集合中

http://wiki.unity3d.com/index.php?title-SkyboxBlended

在Unity中创建新着色器脚本:像创建C#脚本一样,在Create菜单中选择Shader,而不是选择一个标准Shader.命名资源为SkyboxBlended并双击着色器打开脚本,复制维荐页面上的代码并粘贴到着色器脚本中,顶部一行声明了Shader "Skybox/Blended",这告诉Unity将新着色器添加到Skybox外类的着色器列表下(和常规天空盒同一个分类).
注意

换下来将不会涉及着色器程序的所有细节, Shader编程是高级计算机图形的话题而且超出了本书的讨论范围:如果你在阅读完本书后想进一步学习,可以以http:/docs.unity3d.com/Manual/ShadersOverview.html为起点.

现在你可以设置材质的着色器为Skybox Blended.有12个贴图槽,用于两组图像,其中每组六张图像。将TropicalSunnyDay图像赋予到前六张贴图:剩下的贴图使用DarkStormy系列天空盒图像。

这个新着色器也在设置的项部附近添加了一个Blend滑动条, Blend值控制了如何显示天空盒图像集:当将滑动条从一端调整到另一箱时,天空盒将从睛天过渡到阴天。可以通过调整滑动条并运行游戏来进行测试,但当游戏运行时手动调整天空没有什么作用,因此接下来编写一些代码使天空过渡。

在场景中创建一个新的空对象并命名为Controller.创建一个新脚本并命名为WeatherController.将脚本拖到空对象上,接着编写代码清单9.1中的代码。
